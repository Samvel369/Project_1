name: üöÄ Deploy Flask App to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4  # –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏

      - name: üîê Connect to server and deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}  # –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞
          script: |
            set -e  # –í—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ –ª—é–±–æ–π –∫–æ–º–∞–Ω–¥—ã
            
            echo "üîÑ Updating project..."
            cd ~/Project_1 || exit 1
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ git
            git fetch origin
            if [ $(git rev-parse HEAD) = $(git rev-parse origin/main) ]; then
              echo "‚úÖ No new changes to deploy"
              exit 0
            fi
            
            echo "‚¨áÔ∏è Pulling latest changes..."
            git pull origin main
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ venv
            if [ ! -d "venv" ]; then
              echo "üêç Creating virtual environment..."
              python3 -m venv venv
            fi
            
            echo "üîß Activating venv and installing dependencies..."
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            
            echo "üê≥ Rebuilding containers..."
            docker-compose down --remove-orphans
            docker-compose build --no-cache
            docker-compose up -d
            
            echo "üõ†Ô∏è Running migrations (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)..."
            docker-compose exec web flask db upgrade  # –£–±–µ—Ä–∏—Ç–µ, –µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–π –Ω–µ—Ç
            
            echo "üöÄ Deployment successful!"
            docker-compose ps